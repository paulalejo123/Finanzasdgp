<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DGP Finanzas | Acceso Seguro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #2563eb; 
            --navy: #0f172a; 
            --slate: #475569; 
            --bg: #f8fafc;
            --white: #ffffff;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: radial-gradient(circle at top right, #e2e8f0, #f8fafc); margin: 0; min-height: 100vh; }

        /* --- LOGIN --- */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-card {
            background: var(--white); padding: 40px; border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.08); border: 1px solid var(--border);
            width: 100%; max-width: 440px; position: relative; overflow: hidden;
        }
        .login-card::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, var(--primary), #60a5fa); }
        .brand-section { text-align: center; margin-bottom: 30px; }
        .logo-icon { width: 48px; height: 48px; background: var(--navy); color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; font-size: 20px; }
        .brand-section h2 { margin: 0; font-size: 24px; font-weight: 800; color: var(--navy); letter-spacing: -1px; }

        .input-group { margin-bottom: 20px; }
        label { display: block; font-size: 10px; font-weight: 700; color: var(--navy); margin-bottom: 6px; text-transform: uppercase; }
        .input-wrapper { position: relative; }
        .input-wrapper i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        
        input, select {
            width: 100%; padding: 12px 16px 12px 48px;
            border: 1.5px solid #e2e8f0; border-radius: 12px;
            font-size: 14px; color: var(--navy); background: #fcfdfe; transition: 0.3s;
        }

        .btn-submit {
            width: 100%; padding: 16px; border-radius: 12px; border: none;
            background: var(--navy); color: white; font-weight: 700; cursor: pointer;
        }
        .btn-submit:disabled { background: #94a3b8; }

        /* --- APP --- */
        #app-box { display: none; }
        .navbar { background: white; border-bottom: 1px solid var(--border); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .container { max-width: 500px; margin: 15px auto; padding: 0 15px; }
        
        .stat-card { background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 20px; text-align: center; }
        .quote-box { font-style: italic; color: var(--primary); font-size: 11px; margin-top: 12px; padding: 8px; background: #eff6ff; border-radius: 8px; }

        /* --- REGISTRO ORDENADO --- */
        .register-card { background: #ffffff; padding: 20px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 20px; }
        .form-vertical { display: flex; flex-direction: column; align-items: center; gap: 12px; }
        
        .form-vertical input, .form-vertical select { 
            width: 100%; 
            padding: 10px 15px !important; 
            border-radius: 10px; 
            font-size: 13px; 
            background: #f8fafc;
        }

        /* Selectores pequeños arriba */
        .input-compact { 
            max-width: 180px; 
            height: 38px; 
            font-size: 12px !important; 
            text-align: center;
            margin-bottom: 4px;
        }

        .search-box { margin-bottom: 15px; position: relative; }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--slate); }
        .search-box input { padding-left: 40px !important; }

        .btn-add { 
            width: 100%; 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 14px; 
            border-radius: 10px; 
            font-weight: 700; 
            cursor: pointer; 
            margin-top: 8px; 
        }

        .table-box { background: white; border-radius: 16px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }

        .pos { color: #059669; font-weight: 700; }
        .neg { color: #dc2626; font-weight: 700; }
        .chart-card { background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 30px; }
    </style>
</head>
<body>

<div id="auth-box" class="login-container">
    <div class="login-card">
        <div class="brand-section">
            <div class="logo-icon"><i class="fa-solid fa-vault"></i></div>
            <h2>DGP Finanzas</h2>
        </div>
        
        <div id="reg-nombre-container" style="display:none" class="input-group">
            <label>Nombre Completo</label>
            <div class="input-wrapper"><i class="fa-solid fa-user"></i><input type="text" id="reg-nombre" placeholder="Tu nombre"></div>
        </div>

        <div class="input-group">
            <label>Correo Electrónico</label>
            <div class="input-wrapper"><i class="fa-solid fa-envelope"></i><input type="email" id="email" placeholder="admin@dgp.com"></div>
        </div>
        <div class="input-group">
            <label>Clave</label>
            <div class="input-wrapper"><i class="fa-solid fa-lock"></i><input type="password" id="pass" placeholder="••••••••"></div>
        </div>
        
        <button class="btn-submit" id="btn-main" onclick="ejecutar()">INGRESAR</button>
        <p onclick="toggleAuth()" id="msg-toggle" style="text-align:center; font-size:12px; color:var(--primary); cursor:pointer; margin-top:20px; font-weight:600;">¿No tienes cuenta? Regístrate</p>
    </div>
</div>

<div id="app-box">
    <nav class="navbar">
        <div style="font-weight:800; color:var(--navy); font-size:14px;">DGP FINANZAS</div>
        <div onclick="logout()" style="font-size:10px; color:var(--slate); cursor:pointer; font-weight:700;">CERRAR SESIÓN</div>
    </nav>

    <div class="container">
        <div class="stat-card">
            <small style="color:var(--slate); font-weight:700; text-transform:uppercase; font-size:9px; letter-spacing:1px;">Balance General</small>
            <h1 id="total-display" style="font-size:32px; margin:8px 0 0; letter-spacing:-1px;">$0.00</h1>
            <div id="frase-animo" class="quote-box"></div>
        </div>

        <div class="register-card">
            <h3 style="margin:0 0 15px; font-size:12px; color:var(--primary); font-weight:800; text-transform:uppercase; text-align:center;">Nuevo Registro</h3>
            <div class="form-vertical">
                <input type="date" id="f_fecha" class="input-compact">
                <select id="f_tipo" class="input-compact">
                    <option value="Ingreso">Ingreso (+)</option>
                    <option value="Egreso" selected>Egreso (-)</option>
                </select>
                
                <select id="f_cat"><option>Servicios</option><option>Nómina</option><option>Insumos</option><option>Marketing</option><option>Varios</option></select>
                <input type="number" id="f_monto" placeholder="Monto $">
                <input type="text" id="f_desc" placeholder="Descripción / Concepto">
                
                <button class="btn-add" id="btn-save" onclick="guardar()">GUARDAR MOVIMIENTO</button>
            </div>
        </div>

        <div class="search-box">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input type="text" id="busqueda" placeholder="Filtrar historial..." onkeyup="filtrarDatos()">
        </div>

        <div class="table-box">
            <table>
                <tbody id="tabla-cuerpo"></tbody>
            </table>
        </div>

        <div class="chart-card">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
</div>

<script>
    const URL = "https://script.google.com/macros/s/AKfycbysvYM29fpqFOhyaSTQKUvfymVMgO83PfHeO-wMHjZqAlfd5X7MQZLNxSUhKeYmIf1RgQ/exec";
    let chartInstance = null;
    let datosGlobales = [];
    let modoLogin = true;

    function setHoy() {
        const hoy = new Date();
        hoy.setMinutes(hoy.getMinutes() - hoy.getTimezoneOffset());
        document.getElementById('f_fecha').value = hoy.toISOString().split('T')[0];
    }

    function toggleAuth() {
        modoLogin = !modoLogin;
        document.getElementById('reg-nombre-container').style.display = modoLogin ? 'none' : 'block';
        document.getElementById('btn-main').innerText = modoLogin ? 'INGRESAR' : 'CREAR CUENTA';
        document.getElementById('msg-toggle').innerText = modoLogin ? '¿No tienes cuenta? Regístrate' : 'Ya tengo cuenta, entrar';
    }

    async function ejecutar() {
        const email = document.getElementById('email').value.trim();
        const pass = document.getElementById('pass').value.trim();
        const nombre = document.getElementById('reg-nombre').value.trim();
        const btn = document.getElementById('btn-main');

        if (!email || !pass) return alert("Faltan datos");
        
        btn.disabled = true;
        const textoOriginal = btn.innerText;
        btn.innerText = modoLogin ? "VALIDANDO..." : "REGISTRANDO...";

        if (modoLogin) {
            try {
                const res = await fetch(`${URL}?email=${encodeURIComponent(email)}&pass=${encodeURIComponent(pass)}`);
                const txt = await res.text();
                if (txt.includes("ERROR")) { 
                    alert(txt); 
                    btn.disabled = false; 
                    btn.innerText = textoOriginal;
                } else {
                    localStorage.setItem('dgp_auth', JSON.stringify({email, pass}));
                    datosGlobales = JSON.parse(txt);
                    abrirApp(datosGlobales);
                }
            } catch (e) { 
                alert("Error de conexión"); 
                btn.disabled = false; 
                btn.innerText = textoOriginal;
            }
        } else {
            try {
                const res = await fetch(URL, {
                    method: 'POST',
                    body: JSON.stringify({ accion: "signup", email, pass, nombre })
                });
                const txt = await res.text();
                if (txt === "SUCCESS") { 
                    alert("¡Registro exitoso!"); 
                    toggleAuth(); 
                } else { alert(txt); }
            } catch (e) { alert("Error"); }
            btn.disabled = false;
            btn.innerText = "CREAR CUENTA";
        }
    }

    function abrirApp(datos, resetBusqueda = true) {
        document.getElementById('auth-box').style.display = 'none';
        document.getElementById('app-box').style.display = 'block';
        if(resetBusqueda) {
            document.getElementById('busqueda').value = "";
            setHoy();
        }
        
        const frases = ["El control es éxito.", "Gestionar es ganar.", "Cada moneda cuenta."];
        document.getElementById('frase-animo').innerText = `"${frases[Math.floor(Math.random()*frases.length)]}"`;

        let html = "", total = 0, catData = {};
        datos.slice(1).reverse().forEach(f => {
            const m = parseFloat(f[5]); 
            const esI = f[4] === "Ingreso"; 
            total += esI ? m : -m;
            const fechaStr = f[1] ? f[1].toString().substring(0, 10) : "";
            html += `<tr><td><strong>${f[2]}</strong><br><small style="color:var(--slate)">${f[3]} • ${fechaStr}</small></td><td style="text-align:right" class="${esI?'pos':'neg'}">${esI?'+':'-'}$${m.toLocaleString()}</td></tr>`;
            if(!esI) catData[f[3]] = (catData[f[3]] || 0) + m;
        });

        document.getElementById('tabla-cuerpo').innerHTML = html;
        document.getElementById('total-display').innerText = `$${total.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        actualizarGrafico(catData);
    }

    function filtrarDatos() {
        const termino = document.getElementById('busqueda').value.toLowerCase();
        const filtrados = [datosGlobales[0], ...datosGlobales.slice(1).filter(f => f[2].toString().toLowerCase().includes(termino) || f[3].toString().toLowerCase().includes(termino))];
        abrirApp(filtrados, false);
    }

    function actualizarGrafico(catData) {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(catData),
                datasets: [{ data: Object.values(catData), backgroundColor: ['#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', '#1e40af'] }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } }
        });
    }

    async function guardar() {
        const btn = document.getElementById('btn-save'); 
        const auth = JSON.parse(localStorage.getItem('dgp_auth'));
        const d = { email: auth.email, fecha: document.getElementById('f_fecha').value, monto: document.getElementById('f_monto').value, descripcion: document.getElementById('f_desc').value, categoria: document.getElementById('f_cat').value, tipo: document.getElementById('f_tipo').value };
        
        if (!d.monto || !d.descripcion) return alert("Completa los campos");

        btn.disabled = true;
        btn.innerText = "GUARDANDO...";
        try {
            await fetch(URL, { method: 'POST', body: JSON.stringify(d) });
            const res = await fetch(`${URL}?email=${encodeURIComponent(auth.email)}&pass=${encodeURIComponent(auth.pass)}`);
            datosGlobales = JSON.parse(await res.text());
            abrirApp(datosGlobales);
            document.getElementById('f_monto').value = ""; document.getElementById('f_desc').value = "";
            setHoy();
        } catch (e) { alert("Error al guardar"); }
        btn.disabled = false;
        btn.innerText = "GUARDAR MOVIMIENTO";
    }

    function logout() { localStorage.clear(); location.reload(); }
    
    window.onload = () => {
        setHoy();
        const auth = JSON.parse(localStorage.getItem('dgp_auth'));
        if (auth) { 
            document.getElementById('email').value = auth.email;
            document.getElementById('pass').value = auth.pass;
            ejecutar(); 
        }
    };
</script>
</body>
</html>
